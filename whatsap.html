<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>העוזר האישי להזמנות - ח.סבן</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/2SbDgD1B/1.png">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --brand: #0b72b9; --accent: #ff9f1c; --bg: #e5ddd5; --app-bg: #f7f7f7;
            --text-dark: #333; --text-light: #666; --border: #e0e0e0;
            --outgoing-bg: #dcf8c6; --incoming-bg: #ffffff; --system-bg: #e1f2fb;
            --radius-l: 20px; --radius-s: 8px; --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Assistant', sans-serif; background-color: var(--bg); }
        .app-container { display: flex; flex-direction: column; height: 100%; max-width: 700px; margin: 0 auto; background-color: var(--app-bg); box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .header { background-color: var(--brand); color: white; padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .header-info { display: flex; align-items: center; }
        .header-info img { width: 45px; height: 45px; border-radius: 50%; margin-left: 15px; border: 2px solid white; }
        .header-info div { display: flex; flex-direction: column; }
        .header-title { font-size: 1.1rem; font-weight: 700; }
        .header-subtitle { font-size: 0.8rem; opacity: 0.9; }
        .chat-canvas { flex: 1; overflow-y: auto; padding: 20px; background-image: url('https://i.postimg.cc/D0m2hL1W/sban-bg.png'); background-size: cover; background-position: center; }
        .message-bubble { max-width: 80%; padding: 10px 15px; border-radius: var(--radius-l); margin-bottom: 10px; line-height: 1.5; word-wrap: break-word; box-shadow: var(--shadow); transition: all 0.3s ease; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .message-bubble.outgoing { background-color: var(--outgoing-bg); align-self: flex-end; margin-right: 0; margin-left: auto; border-bottom-right-radius: var(--radius-s); }
        .message-bubble.incoming { background-color: var(--incoming-bg); align-self: flex-start; margin-left: 0; margin-right: auto; border-bottom-left-radius: var(--radius-s); }
        .message-bubble.system { font-size: 0.8rem; color: var(--text-light); text-align: center; background-color: var(--system-bg); padding: 8px 12px; max-width: 90%; margin: 10px auto; border-radius: var(--radius-s); }
        .message-meta { font-size: 0.7rem; color: var(--text-light); margin-top: 5px; text-align: left; }
        .chat-input-area { display: flex; padding: 15px; border-top: 1px solid var(--border); background-color: var(--app-bg); }
        .chat-input { flex: 1; border: 1px solid var(--border); border-radius: var(--radius-l); padding: 12px 18px; font-size: 1rem; transition: border-color 0.3s; }
        .chat-input:focus { outline: none; border-color: var(--brand); }
        .send-btn { background-color: var(--brand); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; margin-right: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s; }
        .send-btn:hover { background-color: #085a94; }
        .send-btn svg { width: 24px; height: 24px; }
        .buttons-container { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; align-items: stretch; }
        .action-button { background-color: white; color: var(--brand); border: 1px solid var(--brand); padding: 12px; border-radius: var(--radius-s); cursor: pointer; transition: all 0.2s; font-weight: 600; text-align: center; }
        .action-button:hover { background-color: var(--brand); color: white; }
        .spinner-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; flex-direction: column; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--brand); animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner-text { margin-top: 10px; color: var(--text-dark); font-weight: 600; }
        .typing-indicator { align-self: flex-start; background-color: var(--incoming-bg); padding: 12px 15px; }
        .typing-indicator span { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background-color: #ccc; margin: 0 2px; animation: bounce 1.3s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-info">
                <img src="https://i.postimg.cc/2SbDgD1B/1.png" alt="Avatar">
                <div>
                    <div class="header-title">ח.סבן חומרי בניין</div>
                    <div class="header-subtitle">העוזר האישי להזמנות</div>
                </div>
            </div>
        </header>
        <main class="chat-canvas" id="chat-canvas"></main>
        <footer class="chat-input-area">
            <form id="chat-form" style="display: flex; flex: 1;">
                <input type="text" id="message-input" class="chat-input" placeholder="הקלד הודעה..." autocomplete="off">
                <button type="submit" class="send-btn" aria-label="שלח">
                    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M2,21L23,12L2,3V10L17,12L2,14V21Z" /></svg>
                </button>
            </form>
        </footer>
    </div>

    <div class="spinner-overlay" id="spinner-overlay" style="display: none;">
        <div class="spinner"></div>
        <p class="spinner-text" id="spinner-text">מעבד...</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = 'YOUR_WEB_APP_URL'; // <-- !!! החלף בכתובת ה-URL של ה-Web App שלך !!!

            const dom = {
                canvas: document.getElementById('chat-canvas'),
                form: document.getElementById('chat-form'),
                input: document.getElementById('message-input'),
                spinner: document.getElementById('spinner-overlay'),
                spinnerText: document.getElementById('spinner-text')
            };

            const state = {
                clientId: null, // This will hold the client ID from the URL
                isBotTyping: false
            };

            function init() {
                // Get clientId from URL parameters (e.g., ?clientId=60120)
                const urlParams = new URLSearchParams(window.location.search);
                state.clientId = urlParams.get('clientId');
                
                if (!state.clientId) {
                    console.warn("Client ID not found in URL. Chat will run in anonymous mode.");
                }

                dom.form.addEventListener('submit', handleFormSubmit);
                dom.canvas.addEventListener('click', handleCanvasClick);
                
                startConversation();
            }

            async function startConversation() {
                 showSpinner('מתחבר...');
                 try {
                     const initialMessage = await apiPost({ type: 'start' });
                     renderServerMessage(initialMessage);
                 } catch (error) {
                     console.error("Failed to start conversation:", error);
                     renderSystemMessage("שגיאה בהתחברות לשרת. נסה לרענן את הדף.");
                 } finally {
                    hideSpinner();
                 }
            }

            async function handleFormSubmit(e) {
                e.preventDefault();
                const messageText = dom.input.value.trim();
                if (messageText) {
                    renderUserMessage(messageText);
                    dom.input.value = '';
                    dom.input.disabled = true;
                    setTyping(true);

                    try {
                        const response = await apiPost({ message: messageText });
                        renderServerMessage(response);
                    } catch (error) {
                        console.error("API Error:", error);
                        renderSystemMessage("שגיאה בתקשורת. אנא נסה שוב.");
                    } finally {
                        setTyping(false);
                        dom.input.disabled = false;
                        dom.input.focus();
                    }
                }
            }

            async function handleCanvasClick(e) {
                if (e.target.classList.contains('action-button')) {
                    const title = e.target.textContent;
                    const payload = e.target.dataset.payload;
                    e.target.closest('.buttons-container').remove();
                    
                    renderUserMessage(title);
                    dom.input.disabled = true;
                    setTyping(true);
                    
                    try {
                        const response = await apiPost({ payload: payload });
                        renderServerMessage(response);
                    } catch (error) {
                        console.error("API Error:", error);
                        renderSystemMessage("שגיאה בתקשורת. אנא נסה שוב.");
                    } finally {
                        setTyping(false);
                        dom.input.disabled = false;
                        dom.input.focus();
                    }
                }
            }

            function renderUserMessage(text) {
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble outgoing';
                bubble.textContent = text;
                dom.canvas.appendChild(bubble);
                scrollToBottom();
            }

            function renderServerMessage(response) {
                if (!response || !response.text) return;

                const bubble = document.createElement('div');
                bubble.className = 'message-bubble incoming';
                // Replace markdown-like bold with HTML bold
                bubble.innerHTML = response.text.replace(/\*(.*?)\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');

                if (response.buttons && response.buttons.length > 0) {
                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.className = 'buttons-container';
                    response.buttons.forEach(btn => {
                        const button = document.createElement('button');
                        button.className = 'action-button';
                        button.textContent = btn.title;
                        button.dataset.payload = btn.payload;
                        buttonsContainer.appendChild(button);
                    });
                    bubble.appendChild(buttonsContainer);
                }

                dom.canvas.appendChild(bubble);

                if (response.orderId) {
                    confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                }

                scrollToBottom();
            }
             
            function renderSystemMessage(text) {
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble system';
                bubble.textContent = text;
                dom.canvas.appendChild(bubble);
                scrollToBottom();
            }

            function setTyping(isTyping) {
                let indicator = document.getElementById('typing-indicator');
                if (isTyping && !indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'typing-indicator';
                    indicator.className = 'message-bubble typing-indicator';
                    indicator.innerHTML = '<span></span><span></span><span></span>';
                    dom.canvas.appendChild(indicator);
                    scrollToBottom();
                } else if (!isTyping && indicator) {
                    indicator.remove();
                }
            }
            
            function showSpinner(text) { dom.spinnerText.textContent = text; dom.spinner.style.display = 'flex'; }
            function hideSpinner() { dom.spinner.style.display = 'none'; }
            function scrollToBottom() { dom.canvas.scrollTop = dom.canvas.scrollHeight; }
            
            async function apiPost(body) {
                // Add clientId to every request sent to the backend
                const requestBody = { ...body, clientId: state.clientId };
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    // Use text/plain for Apps Script web app compatibility
                    body: JSON.stringify(requestBody),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            }

            init();
        });
    </script>
</body>
</html>
